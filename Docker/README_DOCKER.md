# MPSA å›¾åƒè¯†åˆ«é¡¹ç›® - Docker ä½¿ç”¨è¯´æ˜

## ğŸ“‹ é¡¹ç›®ä¿¡æ¯

- **é¡¹ç›®åç§°**: MPSA (Multi-granularity Part Sampling Attention) ç»†ç²’åº¦å›¾åƒè¯†åˆ«
- **è®ºæ–‡**: Multi-granularity Part Sampling Attention for Fine-Grained Visual Classification (IEEE TIP 2024)
- **Dockeré•œåƒ**: mpsa-image:v1.0
- **æ”¯æŒæ¨¡å¼**: è®­ç»ƒ (train) / æ¨ç† (inference)
- **æ”¯æŒæ•°æ®é›†**: WebFG-400 (400ç±») / WebiNat-5000 (5000ç±»)

---

## ğŸ³ Docker é•œåƒä¿¡æ¯

### åŸºç¡€ç¯å¢ƒ
- **åŸºç¡€é•œåƒ**: `pytorch/pytorch:2.0.0-cuda11.8-cudnn8-runtime`
- **Pythonç‰ˆæœ¬**: 3.8.10
- **PyTorchç‰ˆæœ¬**: 2.0.0
- **CUDAç‰ˆæœ¬**: 11.8
- **cuDNNç‰ˆæœ¬**: 8

### ä¸»è¦ä¾èµ–
```
timm==1.0.19              # è§†è§‰Transformeråº“
einops==0.8.1             # å¼ é‡æ“ä½œ
opencv-python==4.12.0.88  # å›¾åƒå¤„ç†
yacs==0.1.8               # é…ç½®ç®¡ç†
scipy==1.10.1             # ç§‘å­¦è®¡ç®—
pandas==2.0.3             # æ•°æ®å¤„ç†
matplotlib==3.7.1         # å¯è§†åŒ–
```

å®Œæ•´ä¾èµ–åˆ—è¡¨è§ `requirements_docker.txt`

---

## ğŸ¤– é¢„è®­ç»ƒæ¨¡å‹è¯´æ˜

### æ¨¡å‹ä¿¡æ¯
| æ•°æ®é›† | é¢„è®­ç»ƒæ¨¡å‹ | å¤§å° | æ¥æº | å¤‡æ³¨ |
|--------|-----------|------|------|------|
| **WebFG-400** | `swin_base_patch4_window12_384.pth` | 349MB | [Microsoft Swin Transformer](https://github.com/microsoft/Swin-Transformer) | ImageNet-1ké¢„è®­ç»ƒ |
| **WebiNat-5000** | `swin_base_patch4_window12_384.pth` | 349MB | [Microsoft Swin Transformer](https://github.com/microsoft/Swin-Transformer) | ImageNet-1ké¢„è®­ç»ƒ |

**è¯´æ˜**: ä¸¤ä¸ªæ•°æ®é›†å…±ç”¨åŒä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹æ–‡ä»¶ã€‚è€Œä¸”éƒ½æ˜¯1Kçš„é¢„è®­ç»ƒæ¨¡å‹ã€‚

### æ¨¡å‹ä¸‹è½½é“¾æ¥
- **Swin-Base ImageNet-1k**: https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_base_patch4_window12_384.pth

### å®¹å™¨å†…è·¯å¾„
- é¢„è®­ç»ƒæ¨¡å‹å·²æ‰“åŒ…åœ¨Dockeré•œåƒå†…
- å®¹å™¨å†…è·¯å¾„: `/app/pretrained/swin_base_patch4_window12_384.pth`

---

## ğŸ“‚ æ•°æ®é›†ç»“æ„è¦æ±‚

âš ï¸ **é‡è¦**: æˆ‘æ˜¯æŒ‰ç…§å½“åˆèµ›äº‹æ–¹æä¾›çš„ç½‘ç›˜ä¸‹è½½çš„ï¼Œç›®å½•ç»“æ„å°±æ˜¯è¿™æ ·æ²¡æ”¹åŠ¨è¿‡ï¼Œå¦‚æœä¸ä¸€æ ·çš„è¯å¯èƒ½ä¼šæ— æ³•æ­£å¸¸è¿è¡Œã€‚

### WebFG-400 æ•°æ®é›†ç»“æ„

```
/your/dataset/root/
â”œâ”€â”€ webfg400_train/
â”‚   â””â”€â”€ train/
â”‚       â”œâ”€â”€ 000/
â”‚       â”‚   â”œâ”€â”€ image1.jpg
â”‚       â”‚   â”œâ”€â”€ image2.jpg
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ 001/
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ ...
â”‚       â””â”€â”€ 399/
â”‚           â””â”€â”€ ...
â””â”€â”€ webfg400_test_B/
    â””â”€â”€ test_B/
        â”œâ”€â”€ 00020cabc407464b805752432ecd4dfa.jpg
        â”œâ”€â”€ 0002bacfb5d84c3890aa71a16a400883.jpg
        â””â”€â”€ ...
```

**è¯´æ˜**:
- è®­ç»ƒé›†: 400ä¸ªç±»åˆ«æ–‡ä»¶å¤¹ï¼ˆ000-399ï¼‰ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹åŒ…å«è¯¥ç±»åˆ«çš„å›¾ç‰‡
- æµ‹è¯•é›†: æ‰€æœ‰å›¾ç‰‡åœ¨ `test_B` ç›®å½•ä¸‹ï¼ˆBæ¦œï¼‰ï¼Œæ— æ ‡ç­¾
- å›¾ç‰‡æ ¼å¼: `.jpg`

### WebiNat-5000 æ•°æ®é›†ç»“æ„

```
/your/dataset/root/
â”œâ”€â”€ webinat5000_train/
â”‚   â””â”€â”€ train/
â”‚       â”œâ”€â”€ 0000/
â”‚       â”‚   â”œâ”€â”€ image1.jpg
â”‚       â”‚   â”œâ”€â”€ image2.jpg
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ 0001/
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ ...
â”‚       â””â”€â”€ 4999/
â”‚           â””â”€â”€ ...
â””â”€â”€ webinat5000_test_B/
    â””â”€â”€ test_B/
        â”œâ”€â”€ 00020cabc407464b805752432ecd4dfa.jpg
        â”œâ”€â”€ 0002bacfb5d84c3890aa71a16a400883.jpg
        â””â”€â”€ ...
```

**è¯´æ˜**:
- è®­ç»ƒé›†: 5000ä¸ªç±»åˆ«æ–‡ä»¶å¤¹ï¼ˆ0000-4999ï¼‰ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹åŒ…å«è¯¥ç±»åˆ«çš„å›¾ç‰‡
- æµ‹è¯•é›†: æ‰€æœ‰å›¾ç‰‡åœ¨ `test_B` ç›®å½•ä¸‹ï¼ˆBæ¦œï¼‰ï¼Œæ— æ ‡ç­¾
- å›¾ç‰‡æ ¼å¼: `.jpg`

### å®¹å™¨å†…æŒ‚è½½è·¯å¾„

æ•°æ®é›†å°†é€šè¿‡ `-v` å‚æ•°æŒ‚è½½åˆ°å®¹å™¨å†…çš„ `/data/` ç›®å½•ï¼š
- å®¿ä¸»æœº: `/your/dataset/root/`
- å®¹å™¨å†…: `/data/`
- è®¿é—®ç¤ºä¾‹: 
  - `/data/webfg400_train/train/000/*.jpg`
  - `/data/webinat5000_test_B/test_B/*.jpg` (Bæ¦œæµ‹è¯•é›†)

---

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤ 1: åŠ è½½ Docker é•œåƒ

#### æ–¹å¼ A: ä» tar æ–‡ä»¶åŠ è½½ï¼ˆç¦»çº¿ï¼‰
```bash
docker load -i mpsa-image-v1.0.tar
```

#### æ–¹å¼ B: ä» Docker Hub æ‹‰å–ï¼ˆåœ¨çº¿ï¼‰
```bash
docker pull <your-repo>/mpsa-image:v1.0
```

#### éªŒè¯é•œåƒ
```bash
docker images | grep mpsa-image
# åº”è¯¥çœ‹åˆ°: mpsa-image   v1.0   ...
```

### æ­¥éª¤ 2: å‡†å¤‡æ•°æ®é›†

ç¡®ä¿æ‚¨çš„æ•°æ®é›†æŒ‰ç…§ä¸Šè¿°ç»“æ„ç»„ç»‡ï¼Œå¹¶è®°ä¸‹æ•°æ®é›†æ ¹ç›®å½•çš„å®Œæ•´è·¯å¾„ã€‚

ç¤ºä¾‹è·¯å¾„: `/root/autodl-tmp/database/`

### æ­¥éª¤ 3: è¿è¡Œå¯åŠ¨è„šæœ¬

```bash
bash run.sh
```

å¯åŠ¨è„šæœ¬ä¼šæä¾›äº¤äº’å¼é€‰æ‹©ç•Œé¢ï¼š

#### äº¤äº’ç¤ºä¾‹

```
==========================================
     MPSA å›¾åƒè¯†åˆ«é¡¹ç›® - Dockerå¯åŠ¨è„šæœ¬
==========================================

[æ­¥éª¤ 1/3] è¯·é€‰æ‹©è¿è¡Œæ¨¡å¼ï¼š
  1. è®­ç»ƒæ¨¡å¼ (train)
  2. æ¨ç†æ¨¡å¼ (inference)

è¯·è¾“å…¥é€‰é¡¹ [1/2]: 1

âœ“ å·²é€‰æ‹©ï¼šè®­ç»ƒæ¨¡å¼ (train)

[æ­¥éª¤ 2/3] è¯·é€‰æ‹©æ•°æ®é›†ï¼š
  1. WebFG-400 (400ç±»)
  2. WebiNat-5000 (5000ç±»)

è¯·è¾“å…¥é€‰é¡¹ [1/2]: 2

âœ“ å·²é€‰æ‹©ï¼šWebiNat-5000 æ•°æ®é›†

[æ­¥éª¤ 3/3] è¯·è¾“å…¥å®¿ä¸»æœºæ•°æ®é›†æ ¹ç›®å½•è·¯å¾„

è¯´æ˜ï¼š
  æ•°æ®é›†åº”åŒ…å«ä»¥ä¸‹å­ç›®å½•ï¼š
    - webinat5000_train/train/  (è®­ç»ƒé›†)
    - webinat5000_test_B/test_B/  (Bæ¦œæµ‹è¯•é›†)

ç¤ºä¾‹ï¼š/root/autodl-tmp/database

æ•°æ®é›†è·¯å¾„: /root/autodl-tmp/database

âœ“ æ•°æ®é›†è·¯å¾„éªŒè¯é€šè¿‡

==========================================
å³å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
==========================================
  - è¿è¡Œæ¨¡å¼: train
  - æ•°æ®é›†: webinat5000
  - æ•°æ®è·¯å¾„: /root/autodl-tmp/database
  - è¾“å‡ºè·¯å¾„: ./outputs
  - Dockeré•œåƒ: mpsa-image:v1.0
==========================================

ç¡®è®¤å¯åŠ¨å®¹å™¨ï¼Ÿ[Y/n]: Y

ğŸ³ æ£€æŸ¥Dockeré•œåƒ...
âœ“ Dockeré•œåƒå·²å°±ç»ª

==========================================
ğŸš€ æ­£åœ¨å¯åŠ¨Dockerå®¹å™¨...
==========================================
```

### æ­¥éª¤ 4: æŸ¥çœ‹è¾“å‡ºç»“æœ

è®­ç»ƒæˆ–æ¨ç†å®Œæˆåï¼Œç»“æœä¼šä¿å­˜åœ¨å½“å‰ç›®å½•çš„ `outputs/` æ–‡ä»¶å¤¹ä¸­ï¼š

```bash
ls -lh outputs/
```

#### è®­ç»ƒæ¨¡å¼è¾“å‡º
- æ¨¡å‹æƒé‡: `checkpoint.bin`
- è®­ç»ƒæ—¥å¿—: `training_*.log`
- é…ç½®æ–‡ä»¶: `config.json`

#### æ¨ç†æ¨¡å¼è¾“å‡º
- é¢„æµ‹ç»“æœ: `pred_results_web400.csv` æˆ– `pred_results_web5000.csv`
- æ¨ç†æ—¥å¿—: `inference_*.log`

---

## ğŸ“ å¤ç°è„šæœ¬è¯´æ˜

### è„šæœ¬æ–‡ä»¶
- **run.sh**: å®¿ä¸»æœºå¯åŠ¨è„šæœ¬ï¼ˆäº¤äº’å¼ï¼‰
- **start.sh**: å®¹å™¨å†…æ‰§è¡Œè„šæœ¬ï¼ˆè‡ªåŠ¨åŒ–ï¼‰

### run.sh åŠŸèƒ½
1. äº¤äº’å¼é€‰æ‹©è¿è¡Œæ¨¡å¼ï¼ˆtrain/inferenceï¼‰
2. äº¤äº’å¼é€‰æ‹©æ•°æ®é›†ï¼ˆwebfg400/webinat5000ï¼‰
3. äº¤äº’å¼è¾“å…¥æ•°æ®é›†è·¯å¾„
4. éªŒè¯æ•°æ®é›†ç›®å½•æ˜¯å¦å­˜åœ¨
5. è‡ªåŠ¨æ„å»º `docker run` å‘½ä»¤
6. æ‰§è¡Œå®¹å™¨å¹¶ä¼ é€’å‚æ•°
7. æ˜¾ç¤ºè¾“å‡ºç»“æœä½ç½®

### start.sh åŠŸèƒ½
1. è§£æè¿è¡Œå‚æ•°ï¼ˆæ¨¡å¼ + æ•°æ®é›†ï¼‰
2. é€‰æ‹©å¯¹åº”çš„é…ç½®æ–‡ä»¶
3. è‡ªåŠ¨ä¿®æ”¹ setup.py é…ç½®
4. è®¾ç½®æ¨ç†/è®­ç»ƒæ¨¡å¼
5. æ£€æŸ¥æ•°æ®é›†å’Œé¢„è®­ç»ƒæ¨¡å‹
6. æ‰§è¡Œä¸»ç¨‹åº (main.py)
7. å¤åˆ¶è¾“å‡ºç»“æœåˆ°æŒ‚è½½ç›®å½•
8. æ¢å¤åŸå§‹é…ç½®

### Docker run å‘½ä»¤è¯¦è§£

è„šæœ¬ä¼šè‡ªåŠ¨æ„å»ºå¦‚ä¸‹å‘½ä»¤ï¼š

```bash
docker run --rm \
    --gpus all \
    -v /your/dataset/path:/data:ro \
    -v ./outputs:/outputs \
    --shm-size=16g \
    --ipc=host \
    mpsa-image:v1.0 \
    train webinat5000
```

**å‚æ•°è¯´æ˜**:
- `--rm`: å®¹å™¨é€€å‡ºåè‡ªåŠ¨åˆ é™¤
- `--gpus all`: ä½¿ç”¨æ‰€æœ‰å¯ç”¨GPU
- `-v /your/dataset/path:/data:ro`: æŒ‚è½½æ•°æ®é›†ä¸ºåªè¯»
- `-v ./outputs:/outputs`: æŒ‚è½½è¾“å‡ºç›®å½•ä¸ºå¯è¯»å†™
- `--shm-size=16g`: å…±äº«å†…å­˜å¤§å°ï¼ˆDataLoaderéœ€è¦ï¼‰
- `--ipc=host`: ä½¿ç”¨å®¿ä¸»æœºIPCå‘½åç©ºé—´
- `train webinat5000`: ä¼ é€’ç»™ start.sh çš„å‚æ•°

---

## âš™ï¸ ç¯å¢ƒè¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- **GPU**: NVIDIA GPUï¼ˆæ”¯æŒCUDA 11.8ï¼‰
- **æ˜¾å­˜**: å»ºè®® â‰¥ 16GB
  - WebFG-400: æœ€ä½ 8GB (batch_size=16)
  - WebiNat-5000: æœ€ä½ 16GB (batch_size=64)
- **å†…å­˜**: å»ºè®® â‰¥ 32GB
- **å­˜å‚¨**: 
  - Dockeré•œåƒ: ~5GB
  - æ¨¡å‹è®­ç»ƒè¾“å‡º: ~1GB
  - æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶: ~500MB

### è½¯ä»¶è¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linux (æ¨è Ubuntu 18.04+)
- **Docker**: 20.10+
- **NVIDIA Driver**: â‰¥ 450.80.02 (æ”¯æŒCUDA 11.8)
- **nvidia-docker2**: å·²å®‰è£…å¹¶é…ç½®

### é©±åŠ¨ç‰ˆæœ¬æ£€æŸ¥
```bash
# æ£€æŸ¥NVIDIAé©±åŠ¨
nvidia-smi

# æ£€æŸ¥Docker
docker --version

# æ£€æŸ¥nvidia-docker
docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu20.04 nvidia-smi
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### æ‰‹åŠ¨è¿è¡Œï¼ˆä¸ä½¿ç”¨ run.shï¼‰

#### è®­ç»ƒ WebFG-400
```bash
docker run --rm --gpus all \
  -v /path/to/dataset:/data:ro \
  -v $(pwd)/outputs:/outputs \
  --shm-size=16g --ipc=host \
  mpsa-image:v1.0 train webfg400
```

#### æ¨ç† WebiNat-5000
```bash
docker run --rm --gpus all \
  -v /path/to/dataset:/data:ro \
  -v $(pwd)/outputs:/outputs \
  --shm-size=16g --ipc=host \
  mpsa-image:v1.0 inference webinat5000
```

### è¿›å…¥å®¹å™¨è°ƒè¯•
```bash
docker run -it --rm --gpus all \
  -v /path/to/dataset:/data:ro \
  -v $(pwd)/outputs:/outputs \
  --shm-size=16g --ipc=host \
  --entrypoint /bin/bash \
  mpsa-image:v1.0
```

åœ¨å®¹å™¨å†…æ‰‹åŠ¨è¿è¡Œï¼š
```bash
cd /app
python main.py
```

---

## â“ å¸¸è§é—®é¢˜

### 1. æç¤º"é•œåƒä¸å­˜åœ¨"
**é—®é¢˜**: `Error response from daemon: No such image: mpsa-image:v1.0`

**è§£å†³**: 
```bash
# æ£€æŸ¥é•œåƒæ˜¯å¦åŠ è½½
docker images | grep mpsa

# å¦‚æœæ²¡æœ‰ï¼Œé‡æ–°åŠ è½½
docker load -i mpsa-image-v1.0.tar
```

### 2. GPUä¸å¯ç”¨
**é—®é¢˜**: `RuntimeError: CUDA out of memory` æˆ– `No CUDA GPUs are available`

**è§£å†³**: 
```bash
# æ£€æŸ¥GPU
nvidia-smi

# æ£€æŸ¥nvidia-docker
docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu20.04 nvidia-smi

# å¦‚æœä¸è¡Œï¼Œå®‰è£…nvidia-docker2
```

### 3. æ•°æ®é›†è·¯å¾„é”™è¯¯
**é—®é¢˜**: `è­¦å‘Šï¼šè®­ç»ƒé›†ç›®å½•ä¸å­˜åœ¨`

**è§£å†³**: 
- ç¡®ä¿æ•°æ®é›†ç»“æ„ä¸æœ¬æ–‡æ¡£æè¿°ä¸€è‡´
- æ£€æŸ¥è·¯å¾„æ‹¼å†™æ˜¯å¦æ­£ç¡®
- ç¡®ä¿æœ‰è¯»å–æƒé™

### 4. å…±äº«å†…å­˜ä¸è¶³
**é—®é¢˜**: `ERROR: Unexpected bus error encountered in worker`

**è§£å†³**: 
- å¢åŠ  `--shm-size` å‚æ•°ï¼Œä¾‹å¦‚ `--shm-size=32g`
- æˆ–æ·»åŠ  `--ipc=host`

### 5. æƒé™é—®é¢˜
**é—®é¢˜**: è¾“å‡ºæ–‡ä»¶æ— æ³•å†™å…¥

**è§£å†³**: 
```bash
# ç¡®ä¿outputsç›®å½•æœ‰å†™æƒé™
chmod 777 outputs/

# æˆ–ä½¿ç”¨sudoè¿è¡Œ
sudo bash run.sh
```

---

## ğŸ“Š é¢„æœŸè¾“å‡º

### è®­ç»ƒæ¨¡å¼ - WebFG-400
```
é¢„æœŸè®­ç»ƒæ—¶é—´: ~8-12å°æ—¶ (å•GPU)
è¾“å‡ºæ–‡ä»¶:
  - checkpoint.bin (~430MB)
  - training_webfg400_*.log
  - config.json
é¢„æœŸå‡†ç¡®ç‡: Top-1 ~75-80%
```

### è®­ç»ƒæ¨¡å¼ - WebiNat-5000
```
é¢„æœŸè®­ç»ƒæ—¶é—´: ~20-30å°æ—¶ (å•GPU)
è¾“å‡ºæ–‡ä»¶:
  - checkpoint.bin (~430MB)
  - training_webinat5000_*.log
  - config.json
é¢„æœŸå‡†ç¡®ç‡: Top-1 ~65-70%
```

### æ¨ç†æ¨¡å¼ - WebFG-400
```
é¢„æœŸæ¨ç†æ—¶é—´: ~10-15åˆ†é’Ÿ
è¾“å‡ºæ–‡ä»¶:
  - pred_results_web400.csv
  - inference_webfg400_*.log
CSVæ ¼å¼ç¤ºä¾‹:
  00020cabc407464b805752432ecd4dfa.jpg, 0042
  0002bacfb5d84c3890aa71a16a400883.jpg, 0123
```

### æ¨ç†æ¨¡å¼ - WebiNat-5000
```
é¢„æœŸæ¨ç†æ—¶é—´: ~30-40åˆ†é’Ÿ  
è¾“å‡ºæ–‡ä»¶:
  - pred_results_web5000.csv (40,000è¡Œ)
  - inference_webinat5000_*.log
CSVæ ¼å¼ç¤ºä¾‹:
  00020cabc407464b805752432ecd4dfa.jpg, 1647
  0002bacfb5d84c3890aa71a16a400883.jpg, 4330
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. è¿è¡Œçš„å®Œæ•´å‘½ä»¤
2. é”™è¯¯æ—¥å¿—ï¼ˆoutputsç›®å½•ä¸­çš„.logæ–‡ä»¶ï¼‰
3. GPUå’Œé©±åŠ¨ä¿¡æ¯ï¼ˆ`nvidia-smi`è¾“å‡ºï¼‰
4. Dockerç‰ˆæœ¬ï¼ˆ`docker --version`ï¼‰
5. æ•°æ®é›†ç›®å½•ç»“æ„ï¼ˆ`tree -L 3 /path/to/dataset`ï¼‰

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº MPSA è®ºæ–‡å®ç°ï¼Œéµå¾ªåŸé¡¹ç›®çš„è®¸å¯è¯ã€‚
é¢„è®­ç»ƒæ¨¡å‹æ¥è‡ª Microsoft Swin Transformerï¼Œéµå¾ªå…¶è®¸å¯è¯ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-11-04  
**Dockeré•œåƒç‰ˆæœ¬**: mpsa-image:v1.0

